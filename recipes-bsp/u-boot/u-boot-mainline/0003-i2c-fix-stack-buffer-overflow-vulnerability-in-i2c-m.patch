From 97441c4c60945d7bec756ea8776b3471043204c2 Mon Sep 17 00:00:00 2001
From: Marek Vasut <marex@denx.de>
Date: Thu, 25 Aug 2022 21:38:49 +0200
Subject: [PATCH 3/3] i2c: fix stack buffer overflow vulnerability in i2c md
 command

This reinstates fix from commit 8f8c04bf1ebbd2f72f1643e7ad9617dafa6e5409
without the changes unrelated to the actual fix. Avoid the underflow by
setting only nbytes and linebytes as unsigned integers.

Upstream-Status: Pending
Signed-off-by: Marek Vasut <marex@denx.de>
Cc: Heiko Schocher <hs@denx.de>
Cc: Nicolas Iooss <nicolas.iooss+uboot@ledger.fr>
Cc: Simon Glass <sjg@chromium.org>
Cc: Tim Harvey <tharvey@gateworks.com>
---
 cmd/i2c.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/cmd/i2c.c b/cmd/i2c.c
index 9050b2b8d27..e196a73efa6 100644
--- a/cmd/i2c.c
+++ b/cmd/i2c.c
@@ -470,7 +470,8 @@ static int do_i2c_md(struct cmd_tbl *cmdtp, int flag, int argc,
 	uint	chip;
 	uint	addr, length;
 	int alen;
-	int	j, nbytes, linebytes;
+	int j;
+	uint nbytes, linebytes;
 	int ret;
 #if CONFIG_IS_ENABLED(DM_I2C)
 	struct udevice *dev;
-- 
2.35.1

